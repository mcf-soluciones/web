<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Visita</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .task-form, #welcome-message, #submit-all-container, #completion-message {
            display: none; /* Hide all dynamic sections by default */
        }
        #initial-setup {
            display: block; /* Show setup by default */
        }
        .warn-color { color: #c22121; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="text-center">
            <h1>Registro de Tareas</h1>
            <p class="lead">Complete los datos iniciales para comenzar.</p>
            <p><strong>ID de Visita:</strong> <span id="visit-id-display"></span></p>
        </div>

        <div id="initial-setup" class="card mt-4">
            <div class="card-body">
                <h3 class="card-title">Información de la Visita</h3>
                <form id="setup-form">
                    <div class="form-group">
                        <label for="location-select">¿En qué sucursal te encuentras?</label>
                        <select class="form-control" id="location-select" required>
                            <option value="" disabled selected>Selecciona una opción</option>
                            <option value="hortaleza">hortaleza</option>
                            <option value="usera">usera</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="user-select">¿Quién eres?</label>
                        <select class="form-control" id="user-select" required>
                            <option value="" disabled selected>Selecciona una opción</option>
                            <option value="lalo">lalo</option>
                            <option value="oscar">oscar</option>
                            <option value="adrian">adrian</option>
                            <option value="kenia">kenia</option>
                        </select>
                    </div>
                    <hr>
                    <p class="text-muted">Por favor, evalúa el estado de limpieza inicial (1 = malo, 10 = bueno):</p>
                    <div class="form-group">
                        <label for="limpieza-general">1. Limpieza inicial general (1 al 10)</label>
                        <input type="number" class="form-control" id="limpieza-general" min="1" max="10" required>
                    </div>
                    <div class="form-group">
                        <label for="limpieza-maquinas">2. Limpieza de máquinas (1 al 10)</label>
                        <input type="number" class="form-control" id="limpieza-maquinas" min="1" max="10" required>
                    </div>
                    <div class="form-group">
                        <label for="limpieza-basurero">3. Limpieza de basurero (1 al 10)</label>
                        <input type="number" class="form-control" id="limpieza-basurero" min="1" max="10" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Iniciar Visita</button>
                </form>
            </div>
        </div>

        <div id="welcome-message">
            <h2>Por favor, escanea el código QR de una tarea para registrarla.</h2>
            <p>Tareas completadas: <span id="completed-tasks-count">0</span></p>
        </div>
        
        <div id="completion-message" class="alert alert-success">
            <h4>¡Visita registrada con éxito!</h4>
            <p>Todos los datos han sido enviados. Puede cerrar esta ventana.</p>
        </div>

        <div id="no-session-error" class="alert alert-danger" style="display: none;">
            <h4>Error: Sesión no iniciada</h4>
            <p>Por favor, regresa a la página principal para iniciar una sesión antes de escanear un código QR.</p>
            <a href="final-visit.html" class="btn btn-primary">Iniciar Sesión</a>
        </div>

        <!-- Task Forms Container -->
        <div id="tasks-container">
            <!-- Both Locations -->
            <div id="L99001" class="task-form card loc-usera loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Superficies Secadoras <span class="warn-color">*</span></h3><form data-task-id="L99001" data-task-title="Superficies Secadoras"><p>Limpiar superficies de secadoras con pañuelos</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L99002" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Atrás Superficies Secadoras</h3><form data-task-id="L99002" data-task-title="Atrás Superficies Secadoras"><p>Limpiar superficies de secadoras atrás con pañuelos</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L99003" class="task-form card loc-usera loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Superficies Lavadoras <span class="warn-color">*</span></h3><form data-task-id="L99003" data-task-title="Superficies Lavadoras"><p>Limpiar superficies de lavadoras con pañuelos</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L99004" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Atrás Superficies Lavadoras</h3><form data-task-id="L99004" data-task-title="Atrás Superficies Lavadoras"><p>Limpiar superficies de lavadoras atrás con pañuelos</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L99006" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Tirar Botes de la Bodega</h3><form data-task-id="L99006" data-task-title="Tirar Botes de la Bodega"><p>Tirar los botes de insumos en contenedores amarillos afuera</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L99007" class="task-form card loc-usera loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Barrer <span class="warn-color">*</span></h3><form data-task-id="L99007" data-task-title="Barrer"><p>Barrer area de clientes</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L99008" class="task-form card loc-usera loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Trapear <span class="warn-color">*</span></h3><form data-task-id="L99008" data-task-title="Trapear"><p>Trapear area de clientes</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L99014" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Descarga de Billetes y Monedas</h3><form data-task-id="L99014" data-task-title="Descarga de Billetes y Monedas"><p>Descargar billetes y monedas de inzacard</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L99015" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Carga de Monedas</h3><form data-task-id="L99015" data-task-title="Carga de Monedas"><p>Cargar monedas a hopper</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L99012" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Carga de Papel Impression</h3><form data-task-id="L99012" data-task-title="Carga de Papel Impression"><p>Cargar papel de impresion</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L99013" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Carga de Tarjetas Cliente</h3><form data-task-id="L99013" data-task-title="Carga de Tarjetas Cliente"><p>Carga de Tarjetas Cliente</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L99009" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Limpieza Entrada Billetes</h3><form data-task-id="L99009" data-task-title="Limpieza Entrada Billetes"><p>Limpieza Entrada Billetes</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L99010" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Limpieza Entrada Tarjetas</h3><form data-task-id="L99010" data-task-title="Limpieza Entrada Tarjetas"><p>Limpieza Entrada Tarjetas</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L99011" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Limpieza Entrada Billetes</h3><form data-task-id="L99011" data-task-title="Limpieza Entrada Billetes"><p>Limpieza Entrada Billetes</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>

            <!-- Usera Only -->
            <div id="L01001" class="task-form card loc-usera"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 4</h3><form data-task-id="L01001" data-task-title="Reinicio Lavadora 4"><p>Reinicio Lavadora 4</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L01002" class="task-form card loc-usera"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 5</h3><form data-task-id="L01002" data-task-title="Reinicio Lavadora 5"><p>Reinicio Lavadora 5</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L01003" class="task-form card loc-usera"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 6</h3><form data-task-id="L01003" data-task-title="Reinicio Lavadora 6"><p>Reinicio Lavadora 6</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L01004" class="task-form card loc-usera"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 7</h3><form data-task-id="L01004" data-task-title="Reinicio Lavadora 7"><p>Reinicio Lavadora 7</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L01007" class="task-form card loc-usera"><div class="card-body"><h3 class="card-title">Revision Bombas 1</h3><form data-task-id="L01007" data-task-title="Revision Bombas 1"><p>Mover un poco la toma de bomba (boton rojo)</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L01008" class="task-form card loc-usera"><div class="card-body"><h3 class="card-title">Revision Bombas 2</h3><form data-task-id="L01008" data-task-title="Revision Bombas 2"><p>Mover un poco la toma de bomba (boton rojo)</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L01009" class="task-form card loc-usera" data-mandatory="true"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 1 <span class="warn-color">*</span></h3><form data-task-id="L01009" data-task-title="Limpieza Filtro Secadora 1"><p>Limpieza Filtro Secadora 1</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L01010" class="task-form card loc-usera" data-mandatory="true"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 2 <span class="warn-color">*</span></h3><form data-task-id="L01010" data-task-title="Limpieza Filtro Secadora 2"><p>Limpieza Filtro Secadora 2</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L01011" class="task-form card loc-usera" data-mandatory="true"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 3 <span class="warn-color">*</span></h3><form data-task-id="L01011" data-task-title="Limpieza Filtro Secadora 3"><p>Limpieza Filtro Secadora 3</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>

            <!-- Hortaleza Only -->
            <div id="L02001" class="task-form card loc-hortaleza"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 1</h3><form data-task-id="L02001" data-task-title="Reinicio Lavadora 1"><p>Reinicio Lavadora 1</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L02002" class="task-form card loc-hortaleza"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 2</h3><form data-task-id="L02002" data-task-title="Reinicio Lavadora 2"><p>Reinicio Lavadora 2</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L02003" class="task-form card loc-hortaleza"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 3</h3><form data-task-id="L02003" data-task-title="Reinicio Lavadora 3"><p>Reinicio Lavadora 3</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L02004" class="task-form card loc-hortaleza"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 4</h3><form data-task-id="L02004" data-task-title="Reinicio Lavadora 4"><p>Reinicio Lavadora 4</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L02007" class="task-form card loc-hortaleza"><div class="card-body"><h3 class="card-title">Revision Bombas 1</h3><form data-task-id="L02007" data-task-title="Revision Bombas 1"><p>Mover un poco la toma de bomba (boton rojo)</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L02008" class="task-form card loc-hortaleza"><div class="card-body"><h3 class="card-title">Revision Bombas 2</h3><form data-task-id="L02008" data-task-title="Revision Bombas 2"><p>Mover un poco la toma de bomba (boton rojo)</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L02011" class="task-form card loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 5 <span class="warn-color">*</span></h3><form data-task-id="L02011" data-task-title="Limpieza Filtro Secadora 5"><p>Limpieza Filtro Secadora 5</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L02009" class="task-form card loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 6 <span class="warn-color">*</span></h3><form data-task-id="L02009" data-task-title="Limpieza Filtro Secadora 6"><p>Limpieza Filtro Secadora 6</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L02010" class="task-form card loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 7 <span class="warn-color">*</span></h3><form data-task-id="L02010" data-task-title="Limpieza Filtro Secadora 7"><p>Limpieza Filtro Secadora 7</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
        </div>

        <div id="submit-all-container" class="text-center">
            <h3>Finalizar Visita</h3>
            <p>Has completado <span id="completed-tasks-count-final">0</span> tarea(s). ¿Deseas enviar el registro de la visita ahora?</p>
            <div id="mandatory-tasks-tooltip" class="alert alert-warning" style="display: none;"></div>
            <button id="submit-all-btn" class="btn btn-primary btn-lg">Enviar Registro de Visita</button>
            <div class="mt-2" id="feedback-final" style="display:none;"></div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'YOUR_AWS_API_ENDPOINT_HERE';

        document.addEventListener('DOMContentLoaded', () => {
            const visitId = getOrSetVisitId();
            document.getElementById('visit-id-display').textContent = visitId;

            checkInitialSetup();
            handleRouteChange();

            window.addEventListener('hashchange', handleRouteChange);
            document.getElementById('setup-form').addEventListener('submit', saveInitialSetup);
            document.getElementById('tasks-container').addEventListener('submit', saveTaskProgress);
            document.getElementById('submit-all-btn').addEventListener('click', submitAllTasks);
        });

        function getVisitData() {
            const visitId = getOrSetVisitId();
            const data = localStorage.getItem(`visitData_${visitId}`);
            return data ? JSON.parse(data) : { tasks: {} };
        }

        function saveVisitData(data) {
            const visitId = getOrSetVisitId();
            localStorage.setItem(`visitData_${visitId}`, JSON.stringify(data));
        }

        function getOrSetVisitId() {
            let visitId = sessionStorage.getItem('visitId');
            if (!visitId) {
                visitId = `visit-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                sessionStorage.setItem('visitId', visitId);
            }
            return visitId;
        }

        function checkInitialSetup() {
            const visitData = getVisitData();
            if (visitData.location && visitData.user) {
                document.getElementById('initial-setup').style.display = 'none';
                document.getElementById('welcome-message').style.display = 'block';
                updateCompletedCount();
            } else {
                document.getElementById('initial-setup').style.display = 'block';
                document.getElementById('welcome-message').style.display = 'none';
            }
        }

        function saveInitialSetup(event) {
            event.preventDefault();
            const location = document.getElementById('location-select').value;
            const user = document.getElementById('user-select').value;

            const visitData = getVisitData();
            visitData.location = location;
            visitData.user = user;
            saveVisitData(visitData);

            document.getElementById('initial-setup').style.display = 'none';
            handleRouteChange();
        }

        function handleRouteChange() {
            const visitData = getVisitData();
            const location = visitData.location;
            const taskId = window.location.hash.substring(1);
            
            const noSessionError = document.getElementById('no-session-error');
            const initialSetup = document.getElementById('initial-setup');
            const welcomeMessage = document.getElementById('welcome-message');
            const tasksContainer = document.getElementById('tasks-container');
            const submitContainer = document.getElementById('submit-all-container');

            document.querySelectorAll('.task-form').forEach(form => form.style.display = 'none');
            initialSetup.style.display = 'none';
            welcomeMessage.style.display = 'none';
            tasksContainer.style.display = 'none';
            submitContainer.style.display = 'none';
            noSessionError.style.display = 'none';

            if (!location || !visitData.user) {
                if (taskId) {
                    noSessionError.style.display = 'block';
                } else {
                    initialSetup.style.display = 'block';
                }
                return;
            }

            let taskFound = false;
            if (taskId) {
                const taskForm = document.getElementById(taskId);
                if (taskForm && taskForm.classList.contains(`loc-${location}`)) {
                    tasksContainer.style.display = 'block';
                    taskForm.style.display = 'block';
                    taskFound = true;
                }
            }

            if (!taskFound) {
                welcomeMessage.style.display = 'block';
                updateCompletedCount();
            }
        }

        function saveTaskProgress(event) {
            event.preventDefault();
            const form = event.target;
            const taskId = form.dataset.taskId;
            const taskTitle = form.dataset.taskTitle;
            const answer = form.elements['status'].value;

            const visitData = getVisitData();
            visitData.tasks[taskId] = {
                taskTitle: taskTitle,
                answer: answer,
                timestamp: new Date().toISOString()
            };
            saveVisitData(visitData);

            window.location.hash = '';
            form.reset();
        }

        function updateCompletedCount() {
            const visitData = getVisitData();
            const count = Object.keys(visitData.tasks).length;
            
            document.getElementById('completed-tasks-count').textContent = count;
            document.getElementById('completed-tasks-count-final').textContent = count;

            const submitContainer = document.getElementById('submit-all-container');
            if (count > 0) {
                submitContainer.style.display = 'block';
            } else {
                submitContainer.style.display = 'none';
            }
            checkMandatoryTasks();
        }

        function checkMandatoryTasks() {
            const visitData = getVisitData();
            const location = visitData.location;
            if (!location) return;

            const mandatoryTasks = document.querySelectorAll(`[data-mandatory="true"].loc-${location}`);
            const submitBtn = document.getElementById('submit-all-btn');
            const tooltip = document.getElementById('mandatory-tasks-tooltip');
            
            let allMandatoryCompleted = true;
            let missingTasks = [];

            mandatoryTasks.forEach(task => {
                const taskId = task.id;
                if (!visitData.tasks[taskId]) {
                    allMandatoryCompleted = false;
                    missingTasks.push(task.querySelector('h3').textContent.replace('*','').trim());
                }
            });

            if (allMandatoryCompleted) {
                submitBtn.disabled = false;
                tooltip.style.display = 'none';
            } else {
                submitBtn.disabled = true;
                tooltip.innerHTML = `Por favor, completa las siguientes tareas obligatorias para continuar: <strong>${missingTasks.join(', ')}</strong>`;
                tooltip.style.display = 'block';
            }
        }

        async function submitAllTasks() {
            const visitId = getOrSetVisitId();
            const visitData = getVisitData();
            const feedbackEl = document.getElementById('feedback-final');

            const payload = {
                visitId: visitId,
                location: visitData.location,
                user: visitData.user,
                tasks: visitData.tasks,
                submissionTimestamp: new Date().toISOString()
            };

            console.log('Submitting final data:', payload);
            feedbackEl.textContent = 'Enviando...';
            feedbackEl.className = 'alert alert-info';
            feedbackEl.style.display = 'block';
            document.getElementById('submit-all-btn').disabled = true;

            try {
                await new Promise(resolve => setTimeout(resolve, 1500));

                feedbackEl.textContent = '¡Registro de visita enviado con éxito!';
                feedbackEl.className = 'alert alert-success';
                
                localStorage.removeItem(`visitData_${visitId}`);
                sessionStorage.removeItem('visitId');
                
                document.getElementById('welcome-message').style.display = 'none';
                document.getElementById('submit-all-container').style.display = 'none';
                document.getElementById('completion-message').style.display = 'block';

            } catch (error) {
                console.error('Error submitting form:', error);
                feedbackEl.textContent = 'Error al enviar el registro. Inténtalo de nuevo.';
                feedbackEl.className = 'alert alert-danger';
                document.getElementById('submit-all-btn').disabled = false;
            }
        }
    </script>
</body>
</html>