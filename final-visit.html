<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Visita</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .task-form, #welcome-message, #submit-all-container, #completion-message {
            display: none; /* Hide all dynamic sections by default */
        }
        #initial-setup {
            display: block; /* Show setup by default */
        }
        .warn-color { color: #c22121; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="text-center">
            <h1>Registro de Tareas</h1>
            <p class="lead">Complete los datos iniciales para comenzar.</p>
            <p><strong>ID de Visita:</strong> <span id="visit-id-display"></span></p>
        </div>

        <div id="initial-setup" class="card mt-4">
            <div class="card-body">
                <h3 class="card-title">Información de la Visita</h3>
                <form id="setup-form">
                    <div class="form-group">
                        <label for="location-select">¿En qué sucursal te encuentras?</label>
                        <select class="form-control" id="location-select" required>
                            <option value="" disabled selected>Selecciona una opción</option>
                            <option value="hortaleza">hortaleza</option>
                            <option value="usera">usera</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="user-select">¿Quién eres?</label>
                        <select class="form-control" id="user-select" required>
                            <option value="" disabled selected>Selecciona una opción</option>
                            <option value="lalo">lalo</option>
                            <option value="oscar">oscar</option>
                            <option value="adrian">adrian</option>
                            <option value="kenia">kenia</option>
                        </select>
                    </div>
                    <hr>
                    <p class="text-muted">Por favor, evalúa el estado de limpieza inicial (1 = malo, 10 = bueno):</p>
                    <div class="form-group">
                        <label for="limpieza-general">1. Limpieza inicial general (1 al 10)</label>
                        <input type="number" class="form-control" id="limpieza-general" min="1" max="10" required>
                    </div>
                    <div class="form-group">
                        <label for="limpieza-maquinas">2. Limpieza de máquinas (1 al 10)</label>
                        <input type="number" class="form-control" id="limpieza-maquinas" min="1" max="10" required>
                    </div>
                    <div class="form-group">
                        <label for="limpieza-basurero">3. Limpieza de basurero (1 al 10)</label>
                        <input type="number" class="form-control" id="limpieza-basurero" min="1" max="10" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Iniciar Visita</button>
                    <button type="button" id="reset-visit-btn" class="btn btn-secondary">Reset Visit</button>
                </form>
            </div>
        </div>

        <div id="welcome-message">
            <h2>Por favor, escanea el código QR de una tarea para registrarla.</h2>
            <p>Tareas completadas: <span id="completed-tasks-count">0</span></p>
        </div>
        
        <div id="completion-message" class="alert alert-success">
            <h4>¡Visita registrada con éxito!</h4>
            <p>Todos los datos han sido enviados. Puede cerrar esta ventana.</p>
        </div>

        <div id="no-session-error" class="alert alert-danger" style="display: none;">
            <h4>Error: Sesión no iniciada</h4>
            <p>Por favor, regresa a la página principal para iniciar una sesión antes de escanear un código QR.</p>
            <a href="final-visit.html" class="btn btn-primary">Iniciar Sesión</a>
        </div>

        <!-- Task Forms Container -->
        <div id="tasks-container">
            <!-- Both Locations -->
            <div id="L99001" class="task-form card loc-usera loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Superficies Secadoras <span class="warn-color">*</span></h3><form data-task-id="L99001" data-task-title="Superficies Secadoras"><p>Limpiar superficies de secadoras con pañuelos</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L99002" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Atrás Superficies Secadoras</h3><form data-task-id="L99002" data-task-title="Atrás Superficies Secadoras"><p>Limpiar superficies de secadoras atrás con pañuelos</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L99003" class="task-form card loc-usera loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Superficies Lavadoras <span class="warn-color">*</span></h3><form data-task-id="L99003" data-task-title="Superficies Lavadoras"><p>Limpiar superficies de lavadoras con pañuelos</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L99004" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Atrás Superficies Lavadoras</h3><form data-task-id="L99004" data-task-title="Atrás Superficies Lavadoras"><p>Limpiar superficies de lavadoras atrás con pañuelos</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L99006" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Tirar Botes de la Bodega</h3><form data-task-id="L99006" data-task-title="Tirar Botes de la Bodega"><p>Tirar los botes de insumos en contenedores amarillos afuera</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L99007" class="task-form card loc-usera loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Barrer <span class="warn-color">*</span></h3><form data-task-id="L99007" data-task-title="Barrer"><p>Barrer area de clientes</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L99008" class="task-form card loc-usera loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Trapear <span class="warn-color">*</span></h3><form data-task-id="L99008" data-task-title="Trapear"><p>Trapear area de clientes</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L99014" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Descarga de Billetes y Monedas</h3><form data-task-id="L99014" data-task-title="Descarga de Billetes y Monedas"><p>Descargar billetes y monedas de inzacard</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L99015" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Carga de Monedas</h3><form data-task-id="L99015" data-task-title="Carga de Monedas"><p>Cargar monedas a hopper</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L99012" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Carga de Papel Impression</h3><form data-task-id="L99012" data-task-title="Carga de Papel Impression"><p>Cargar papel de impresion</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L99013" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Carga de Tarjetas Cliente</h3><form data-task-id="L99013" data-task-title="Carga de Tarjetas Cliente"><p>Carga de Tarjetas Cliente</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L99009" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Limpieza Entrada Billetes</h3><form data-task-id="L99009" data-task-title="Limpieza Entrada Billetes"><p>Limpieza Entrada Billetes</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L99010" class="task-form card loc-usera loc-hortaleza"><div class="card-body"><h3 class="card-title">Limpieza Entrada Tarjetas</h3><form data-task-id="L99010" data-task-title="Limpieza Entrada Tarjetas"><p>Limpieza Entrada Tarjetas</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>

            <!-- Usera Only -->
            <div id="L01001" class="task-form card loc-usera"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 4</h3><form data-task-id="L01001" data-task-title="Reinicio Lavadora 4"><p>Reinicio Lavadora 4</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L01002" class="task-form card loc-usera"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 5</h3><form data-task-id="L01002" data-task-title="Reinicio Lavadora 5"><p>Reinicio Lavadora 5</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L01003" class="task-form card loc-usera"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 6</h3><form data-task-id="L01003" data-task-title="Reinicio Lavadora 6"><p>Reinicio Lavadora 6</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L01004" class="task-form card loc-usera"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 7</h3><form data-task-id="L01004" data-task-title="Reinicio Lavadora 7"><p>Reinicio Lavadora 7</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L01007" class="task-form card loc-usera"><div class="card-body"><h3 class="card-title">Revision Bombas 1</h3><form data-task-id="L01007" data-task-title="Revision Bombas 1"><p>Mover un poco la toma de bomba (boton rojo)</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L01008" class="task-form card loc-usera"><div class="card-body"><h3 class="card-title">Revision Bombas 2</h3><form data-task-id="L01008" data-task-title="Revision Bombas 2"><p>Mover un poco la toma de bomba (boton rojo)</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L01009" class="task-form card loc-usera" data-mandatory="true"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 1 <span class="warn-color">*</span></h3><form data-task-id="L01009" data-task-title="Limpieza Filtro Secadora 1"><p>Limpieza Filtro Secadora 1</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L01010" class="task-form card loc-usera" data-mandatory="true"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 2 <span class="warn-color">*</span></h3><form data-task-id="L01010" data-task-title="Limpieza Filtro Secadora 2"><p>Limpieza Filtro Secadora 2</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L01011" class="task-form card loc-usera" data-mandatory="true"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 3 <span class="warn-color">*</span></h3><form data-task-id="L01011" data-task-title="Limpieza Filtro Secadora 3"><p>Limpieza Filtro Secadora 3</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>

            <div id="L01020" class="task-form card loc-usera" data-mandatory="true"><div class="card-body"><h3 class="card-title">Inventario Bodega <span class="warn-color">*</span></h3><form data-task-id="L01020" data-task-title="Inventario Bodega"><div class="form-group"><label>Jabon</label><input type="number" step="any" name="jabon" class="form-control"></div><div class="form-group"><label>Suavizante</label><input type="number" step="any" name="suavizante" class="form-control"></div><div class="form-group"><label>Oxigeno</label><input type="number" step="any" name="oxigeno" class="form-control"></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L01021" class="task-form card loc-usera" data-mandatory="true"><div class="card-body"><h3 class="card-title">Inventario Bomba 1 <span class="warn-color">*</span></h3><form data-task-id="L01021" data-task-title="Inventario Bomba 1"><div class="form-group"><label>Jabon</label><input type="number" step="any" name="jabon" class="form-control"></div><div class="form-group"><label>Suavizante</label><input type="number" step="any" name="suavizante" class="form-control"></div><div class="form-group"><label>Oxigeno</label><input type="number" step="any" name="oxigeno" class="form-control"></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L01022" class="task-form card loc-usera" data-mandatory="true"><div class="card-body"><h3 class="card-title">Inventario Bomba 2 <span class="warn-color">*</span></h3><form data-task-id="L01022" data-task-title="Inventario Bomba 2"><div class="form-group"><label>Jabon</label><input type="number" step="any" name="jabon" class="form-control"></div><div class="form-group"><label>Suavizante</label><input type="number" step="any" name="suavizante" class="form-control"></div><div class="form-group"><label>Oxigeno</label><input type="number" step="any" name="oxigeno" class="form-control"></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>

            <!-- Hortaleza Only -->
            <div id="L02001" class="task-form card loc-hortaleza"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 1</h3><form data-task-id="L02001" data-task-title="Reinicio Lavadora 1"><p>Reinicio Lavadora 1</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L02002" class="task-form card loc-hortaleza"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 2</h3><form data-task-id="L02002" data-task-title="Reinicio Lavadora 2"><p>Reinicio Lavadora 2</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L02003" class="task-form card loc-hortaleza"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 3</h3><form data-task-id="L02003" data-task-title="Reinicio Lavadora 3"><p>Reinicio Lavadora 3</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L02004" class="task-form card loc-hortaleza"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 4</h3><form data-task-id="L02004" data-task-title="Reinicio Lavadora 4"><p>Reinicio Lavadora 4</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L02007" class="task-form card loc-hortaleza"><div class="card-body"><h3 class="card-title">Revision Bombas 1</h3><form data-task-id="L02007" data-task-title="Revision Bombas 1"><p>Mover un poco la toma de bomba (boton rojo)</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L02008" class="task-form card loc-hortaleza"><div class="card-body"><h3 class="card-title">Revision Bombas 2</h3><form data-task-id="L02008" data-task-title="Revision Bombas 2"><p>Mover un poco la toma de bomba (boton rojo)</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L02011" class="task-form card loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 5 <span class="warn-color">*</span></h3><form data-task-id="L02011" data-task-title="Limpieza Filtro Secadora 5"><p>Limpieza Filtro Secadora 5</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L02009" class="task-form card loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 6 <span class="warn-color">*</span></h3><form data-task-id="L02009" data-task-title="Limpieza Filtro Secadora 6"><p>Limpieza Filtro Secadora 6</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L02010" class="task-form card loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 7 <span class="warn-color">*</span></h3><form data-task-id="L02010" data-task-title="Limpieza Filtro Secadora 7"><p>Limpieza Filtro Secadora 7</p><button type="submit" class="btn btn-success btn-lg">Listo</button></form></div></div>
            <div id="L02020" class="task-form card loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Inventario Bodega <span class="warn-color">*</span></h3><form data-task-id="L02020" data-task-title="Inventario Bodega"><div class="form-group"><label>Jabon</label><input type="number" step="any" name="jabon" class="form-control"></div><div class="form-group"><label>Suavizante</label><input type="number" step="any" name="suavizante" class="form-control"></div><div class="form-group"><label>Oxigeno</label><input type="number" step="any" name="oxigeno" class="form-control"></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L02021" class="task-form card loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Inventario Bomba 1 <span class="warn-color">*</span></h3><form data-task-id="L02021" data-task-title="Inventario Bomba 1"><div class="form-group"><label>Jabon</label><input type="number" step="any" name="jabon" class="form-control"></div><div class="form-group"><label>Suavizante</label><input type="number" step="any" name="suavizante" class="form-control"></div><div class="form-group"><label>Oxigeno</label><input type="number" step="any" name="oxigeno" class="form-control"></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="L02022" class="task-form card loc-hortaleza" data-mandatory="true"><div class="card-body"><h3 class="card-title">Inventario Bomba 2 <span class="warn-color">*</span></h3><form data-task-id="L02022" data-task-title="Inventario Bomba 2"><div class="form-group"><label>Jabon</label><input type="number" step="any" name="jabon" class="form-control"></div><div class="form-group"><label>Suavizante</label><input type="number" step="any" name="suavizante" class="form-control"></div><div class="form-group"><label>Oxigeno</label><input type="number" step="any" name="oxigeno" class="form-control"></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
        </div>

        <div id="submit-all-container" class="text-center">
            <h3>Finalizar Visita</h3>
            <p>Has completado <span id="completed-tasks-count-final">0</span> tarea(s). ¿Deseas enviar el registro de la visita ahora?</p>
            <div id="mandatory-tasks-tooltip" class="alert alert-warning" style="display: none;"></div>
            <button id="submit-all-btn" class="btn btn-primary btn-lg">Enviar Registro de Visita</button>
            <div class="mt-2" id="feedback-final" style="display:none;"></div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'YOUR_AWS_API_ENDPOINT_HERE';

        document.addEventListener('DOMContentLoaded', () => {
            const visitId = getOrSetVisitId();
            document.getElementById('visit-id-display').textContent = visitId;

            checkInitialSetup();
            handleRouteChange();

            window.addEventListener('hashchange', handleRouteChange);
            document.getElementById('setup-form').addEventListener('submit', saveInitialSetup);
            document.getElementById('tasks-container').addEventListener('submit', saveTaskProgress);
            document.getElementById('submit-all-btn').addEventListener('click', submitAllTasks);
            document.getElementById('reset-visit-btn').addEventListener('click', resetVisit);
        });

        function resetVisit() {
            const visitId = localStorage.getItem('visitId');
            if (visitId) {
                localStorage.removeItem(`visitData_${visitId}`);
                localStorage.removeItem('visitId');
            }
            // Reload the page to start fresh
            window.location.href = window.location.pathname;
        }

        function getVisitData() {
            const visitId = getOrSetVisitId();
            const data = localStorage.getItem(`visitData_${visitId}`);
            return data ? JSON.parse(data) : { tasks: {} };
        }

        function saveVisitData(data) {
            const visitId = getOrSetVisitId();
            localStorage.setItem(`visitData_${visitId}`, JSON.stringify(data));
        }

        function getOrSetVisitId() {
            let visitId = localStorage.getItem('visitId');
            if (!visitId) {
                visitId = `v1-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('visitId', visitId);
            }
            return visitId;
        }

        function checkInitialSetup() {
            const visitData = getVisitData();
            if (visitData.location && visitData.user) {
                document.getElementById('initial-setup').style.display = 'none';
                document.getElementById('welcome-message').style.display = 'block';
                updateCompletedCount();
            } else {
                document.getElementById('initial-setup').style.display = 'block';
                document.getElementById('welcome-message').style.display = 'none';
            }
        }

        function saveInitialSetup(event) {
            event.preventDefault();
            const location = document.getElementById('location-select').value;
            const user = document.getElementById('user-select').value;
            const limpiezaGeneral = document.getElementById('limpieza-general').value;
            const limpiezaMaquinas = document.getElementById('limpieza-maquinas').value;
            const limpiezaBasurero = document.getElementById('limpieza-basurero').value;

            const visitData = getVisitData();
            visitData.location = location;
            visitData.user = user;
            visitData.limpiezaGeneral = limpiezaGeneral;
            visitData.limpiezaMaquinas = limpiezaMaquinas;
            visitData.limpiezaBasurero = limpiezaBasurero;
            saveVisitData(visitData);

            document.getElementById('initial-setup').style.display = 'none';
            handleRouteChange();
        }

        function handleRouteChange() {
            const visitData = getVisitData();
            const location = visitData.location;
            const taskId = window.location.hash.substring(1);
            
            const noSessionError = document.getElementById('no-session-error');
            const initialSetup = document.getElementById('initial-setup');
            const welcomeMessage = document.getElementById('welcome-message');
            const tasksContainer = document.getElementById('tasks-container');
            const submitContainer = document.getElementById('submit-all-container');

            document.querySelectorAll('.task-form').forEach(form => form.style.display = 'none');
            initialSetup.style.display = 'none';
            welcomeMessage.style.display = 'none';
            tasksContainer.style.display = 'none';
            submitContainer.style.display = 'none';
            noSessionError.style.display = 'none';

            if (!location || !visitData.user) {
                if (taskId) {
                    noSessionError.style.display = 'block';
                } else {
                    initialSetup.style.display = 'block';
                }
                return;
            }

            let taskFound = false;
            if (taskId) {
                const taskForm = document.getElementById(taskId);
                if (taskForm && taskForm.classList.contains(`loc-${location}`)) {
                    tasksContainer.style.display = 'block';
                    taskForm.style.display = 'block';
                    taskFound = true;
                }
            }

            if (!taskFound) {
                welcomeMessage.style.display = 'block';
                updateCompletedCount();
            }
        }

        function saveTaskProgress(event) {
            event.preventDefault();
            const form = event.target;
            const taskId = form.dataset.taskId;
            const taskTitle = form.dataset.taskTitle;

            const visitData = getVisitData();
            const taskData = {
                taskTitle: taskTitle,
                timestamp: new Date().toISOString()
            };

            if (form.elements['status']) {
                taskData.answer = form.elements['status'].value;
            } else if (form.elements['jabon']) {
                taskData.jabon = form.elements['jabon'].value;
                taskData.suavizante = form.elements['suavizante'].value;
                taskData.oxigeno = form.elements['oxigeno'].value;
            } else {
                taskData.answer = true;
            }
            
            visitData.tasks[taskId] = taskData;
            saveVisitData(visitData);

            window.location.hash = '';
            form.reset();
        }

        function updateCompletedCount() {
            const visitData = getVisitData();
            const count = Object.keys(visitData.tasks).length;
            
            document.getElementById('completed-tasks-count').textContent = count;
            document.getElementById('completed-tasks-count-final').textContent = count;

            const submitContainer = document.getElementById('submit-all-container');
            if (count > 0) {
                submitContainer.style.display = 'block';
            } else {
                submitContainer.style.display = 'none';
            }
            checkMandatoryTasks();
        }

        function checkMandatoryTasks() {
            const visitData = getVisitData();
            const location = visitData.location;
            if (!location) return;

            const mandatoryTasks = document.querySelectorAll(`[data-mandatory="true"].loc-${location}`);
            const submitBtn = document.getElementById('submit-all-btn');
            const tooltip = document.getElementById('mandatory-tasks-tooltip');
            
            let allMandatoryCompleted = true;
            let missingTasks = [];

            mandatoryTasks.forEach(task => {
                const taskId = task.id;
                if (!visitData.tasks[taskId]) {
                    allMandatoryCompleted = false;
                    missingTasks.push(task.querySelector('h3').textContent.replace('*','').trim());
                }
            });

            if (allMandatoryCompleted) {
                submitBtn.disabled = false;
                tooltip.style.display = 'none';
            } else {
                submitBtn.disabled = true;
                tooltip.innerHTML = `Por favor, completa las siguientes tareas obligatorias para continuar: <strong>${missingTasks.join(', ')}</strong>`;
                tooltip.style.display = 'block';
            }
        }

        async function submitAllTasks() {
            const visitId = getOrSetVisitId();
            const visitData = getVisitData();
            const feedbackEl = document.getElementById('feedback-final');

            const payload = {
                visitId: visitId,
                location: visitData.location,
                user: visitData.user,
                tasks: visitData.tasks,
                submissionTimestamp: new Date().toISOString()
            };

            console.log('Submitting final data:', payload);
            feedbackEl.textContent = 'Enviando...';
            feedbackEl.className = 'alert alert-info';
            feedbackEl.style.display = 'block';
            document.getElementById('submit-all-btn').disabled = true;

            try {
                await submitToAPI(payload);

                feedbackEl.textContent = '¡Registro de visita enviado con éxito!';
                feedbackEl.className = 'alert alert-success';
                
                localStorage.removeItem(`visitData_${visitId}`);
                localStorage.removeItem('visitId');
                
                document.getElementById('welcome-message').style.display = 'none';
                document.getElementById('submit-all-container').style.display = 'none';
                document.getElementById('completion-message').style.display = 'block';

            } catch (error) {
                console.error('Error submitting form:', error);
                feedbackEl.textContent = 'Error al enviar el registro. Inténtalo de nuevo.';
                feedbackEl.className = 'alert alert-danger';
                document.getElementById('submit-all-btn').disabled = false;
            }
        }

        function submitToAPI(payload) {
            const URL = "https://nd1me8yxw5.execute-api.us-east-1.amazonaws.com/dev-v1/contact";
            const tasks = payload.tasks || {};

            let formattedData = {
                propiedad: payload.location,
                user: payload.user,
                visitId: payload.visitId,
                submissionTimestamp: payload.submissionTimestamp,

                taskCompletionTimestamps: {
                    // Both Locations
                    L99001: tasks.L99001 ? tasks.L99001.timestamp : null,
                    L99002: tasks.L99002 ? tasks.L99002.timestamp : null,
                    L99003: tasks.L99003 ? tasks.L99003.timestamp : null,
                    L99004: tasks.L99004 ? tasks.L99004.timestamp : null,
                    L99006: tasks.L99006 ? tasks.L99006.timestamp : null,
                    L99007: tasks.L99007 ? tasks.L99007.timestamp : null,
                    L99008: tasks.L99008 ? tasks.L99008.timestamp : null,
                    L99014: tasks.L99014 ? tasks.L99014.timestamp : null,
                    L99015: tasks.L99015 ? tasks.L99015.timestamp : null,
                    L99012: tasks.L99012 ? tasks.L99012.timestamp : null,
                    L99013: tasks.L99013 ? tasks.L99013.timestamp : null,
                    L99009: tasks.L99009 ? tasks.L99009.timestamp : null,
                    L99010: tasks.L99010 ? tasks.L99010.timestamp : null,
                    // Usera
                    L01001: tasks.L01001 ? tasks.L01001.timestamp : null,
                    L01002: tasks.L01002 ? tasks.L01002.timestamp : null,
                    L01003: tasks.L01003 ? tasks.L01003.timestamp : null,
                    L01004: tasks.L01004 ? tasks.L01004.timestamp : null,
                    L01007: tasks.L01007 ? tasks.L01007.timestamp : null,
                    L01008: tasks.L01008 ? tasks.L01008.timestamp : null,
                    L01009: tasks.L01009 ? tasks.L01009.timestamp : null,
                    L01010: tasks.L01010 ? tasks.L01010.timestamp : null,
                    L01011: tasks.L01011 ? tasks.L01011.timestamp : null,
                    L01020: tasks.L01020 ? tasks.L01020.timestamp : null,
                    L01021: tasks.L01021 ? tasks.L01021.timestamp : null,
                    L01022: tasks.L01022 ? tasks.L01022.timestamp : null,
                    // Hortaleza
                    L02001: tasks.L02001 ? tasks.L02001.timestamp : null,
                    L02002: tasks.L02002 ? tasks.L02002.timestamp : null,
                    L02003: tasks.L02003 ? tasks.L02003.timestamp : null,
                    L02004: tasks.L02004 ? tasks.L02004.timestamp : null,
                    L02007: tasks.L02007 ? tasks.L02007.timestamp : null,
                    L02008: tasks.L02008 ? tasks.L02008.timestamp : null,
                    L02011: tasks.L02011 ? tasks.L02011.timestamp : null,
                    L02009: tasks.L02009 ? tasks.L02009.timestamp : null,
                    L02010: tasks.L02010 ? tasks.L02010.timestamp : null,
                    L02020: tasks.L02020 ? tasks.L02020.timestamp : null,
                    L02021: tasks.L02021 ? tasks.L02021.timestamp : null,
                    L02022: tasks.L02022 ? tasks.L02022.timestamp : null
                },

                // Cleanliness scores
                L99016: payload.limpiezaGeneral,
                L99017: payload.limpiezaMaquinas,
                L99018: payload.limpiezaBasurero,

                // Both Locations
                L99001: tasks.L99001 ? tasks.L99001.answer : false, //ok
                L99002: tasks.L99002 ? tasks.L99002.answer : false, //ok
                L99003: tasks.L99003 ? tasks.L99003.answer : false, //ok
                L99004: tasks.L99004 ? tasks.L99004.answer : false, //ok
                L99006: tasks.L99006 ? tasks.L99006.answer : false, //ok
                L99007: tasks.L99007 ? tasks.L99007.answer : false, //ok
                L99008: tasks.L99008 ? tasks.L99008.answer : false, //ok
                L99014: tasks.L99014 ? tasks.L99014.answer : false, //ok
                L99015: tasks.L99015 ? tasks.L99015.answer : false, //ok
                L99012: tasks.L99012 ? tasks.L99012.answer : false, //ok
                L99013: tasks.L99013 ? tasks.L99013.answer : false, //ok
                L99009: tasks.L99009 ? tasks.L99009.answer : false, //ok
                L99010: tasks.L99010 ? tasks.L99010.answer : false, //ok

                // Usera Only
                L01001: tasks.L01001 ? tasks.L01001.answer : false, // ok
                L01002: tasks.L01002 ? tasks.L01002.answer : false, // ok
                L01003: tasks.L01003 ? tasks.L01003.answer : false, // ok
                L01004: tasks.L01004 ? tasks.L01004.answer : false, // ok
                L01007: tasks.L01007 ? tasks.L01007.answer : false, // ok
                L01008: tasks.L01008 ? tasks.L01008.answer : false, // ok
                L01009: tasks.L01009 ? tasks.L01009.answer : false, // ok
                L01010: tasks.L01010 ? tasks.L01010.answer : false, // ok
                L01011: tasks.L01011 ? tasks.L01011.answer : false, // ok

                // Hortaleza Only
                L02001: tasks.L02001 ? tasks.L02001.answer : false, // ok
                L02002: tasks.L02002 ? tasks.L02002.answer : false, // ok
                L02003: tasks.L02003 ? tasks.L02003.answer : false, // ok
                L02004: tasks.L02004 ? tasks.L02004.answer : false, // ok
                L02007: tasks.L02007 ? tasks.L02007.answer : false, // ok
                L02008: tasks.L02008 ? tasks.L02008.answer : false, // ok
                L02011: tasks.L02011 ? tasks.L02011.answer : false, // ok
                L02009: tasks.L02009 ? tasks.L02009.answer : false, // ok
                L02010: tasks.L02010 ? tasks.L02010.answer : false, // ok

                // Numeric Inputs - Usera
                L01020_1: tasks.L01020 ? tasks.L01020.jabon : 0, // ok
                L01020_2: tasks.L01020 ? tasks.L01020.suavizante : 0, // ok
                L01020_3: tasks.L01020 ? tasks.L01020.oxigeno : 0, // ok
                L01021_1: tasks.L01021 ? tasks.L01021.jabon : 0, // ok
                L01021_2: tasks.L01021 ? tasks.L01021.suavizante : 0, // ok
                L01021_3: tasks.L01021 ? tasks.L01021.oxigeno : 0, // ok
                L01022_1: tasks.L01022 ? tasks.L01022.jabon : 0, // ok
                L01022_2: tasks.L01022 ? tasks.L01022.suavizante : 0, // ok
                L01022_3: tasks.L01022 ? tasks.L01022.oxigeno : 0, // ok

                // Numeric Inputs - Hortaleza
                L02020_1: tasks.L02020 ? tasks.L02020.jabon : 0, // ok
                L02020_2: tasks.L02020 ? tasks.L02020.suavizante : 0, // ok
                L02020_3: tasks.L02020 ? tasks.L02020.oxigeno : 0, // ok
                L02021_1: tasks.L02021 ? tasks.L02021.jabon : 0, // ok
                L02021_2: tasks.L02021 ? tasks.L02021.suavizante : 0,  // ok
                L02021_3: tasks.L02021 ? tasks.L02021.oxigeno : 0, // ok
                L02022_1: tasks.L02022 ? tasks.L02022.jabon : 0, // ok
                L02022_2: tasks.L02022 ? tasks.L02022.suavizante : 0, // ok
                L02022_3: tasks.L02022 ? tasks.L02022.oxigeno : 0, // ok
            };

            console.log('Sending data to API:', formattedData);

            return $.ajax({
                type: "POST",
                url: URL,
                dataType: "json",
                crossDomain: true,
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(formattedData),
            });
        }
    </script>
</body>
</html>