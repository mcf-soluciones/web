<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Visita</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .task-form, #welcome-message, #submit-all-container, #completion-message {
            display: none; /* Hide all dynamic sections by default */
        }
        #initial-setup {
            display: block; /* Show setup by default */
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="text-center">
            <h1>Registro de Tareas</h1>
            <p class="lead">Complete los datos iniciales para comenzar.</p>
            <p><strong>ID de Visita:</strong> <span id="visit-id-display"></span></p>
        </div>

        <div id="initial-setup" class="card mt-4">
            <div class="card-body">
                <h3 class="card-title">Información de la Visita</h3>
                <form id="setup-form">
                    <div class="form-group">
                        <label for="location-select">¿En qué sucursal te encuentras?</label>
                        <select class="form-control" id="location-select" required>
                            <option value="" disabled selected>Selecciona una opción</option>
                            <option value="hortaleza">hortaleza</option>
                            <option value="usera">usera</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="user-select">¿Quién eres?</label>
                        <select class="form-control" id="user-select" required>
                            <option value="" disabled selected>Selecciona una opción</option>
                            <option value="lalo">lalo</option>
                            <option value="oscar">oscar</option>
                            <option value="adrian">adrian</option>
                            <option value="kenia">kenia</option>
                        </select>
                    </div>
                    <hr>
                    <p class="text-muted">Por favor, evalúa el estado de limpieza inicial (1 = malo, 10 = bueno):</p>
                    <div class="form-group">
                        <label for="limpieza-general">1. Limpieza inicial general (1 al 10)</label>
                        <input type="number" class="form-control" id="limpieza-general" min="1" max="10" required>
                    </div>
                    <div class="form-group">
                        <label for="limpieza-maquinas">2. Limpieza de máquinas (1 al 10)</label>
                        <input type="number" class="form-control" id="limpieza-maquinas" min="1" max="10" required>
                    </div>
                    <div class="form-group">
                        <label for="limpieza-basurero">3. Limpieza de basurero (1 al 10)</label>
                        <input type="number" class="form-control" id="limpieza-basurero" min="1" max="10" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Iniciar Visita</button>
                </form>
            </div>
        </div>

        <div id="welcome-message">
            <h2>Por favor, escanea el código QR de una tarea para registrarla.</h2>
            <p>Tareas completadas: <span id="completed-tasks-count">0</span></p>
        </div>
        
        <div id="completion-message" class="alert alert-success">
            <h4>¡Visita registrada con éxito!</h4>
            <p>Todos los datos han sido enviados. Puede cerrar esta ventana.</p>
        </div>

        <div id="no-session-error" class="alert alert-danger" style="display: none;">
            <h4>Error: Sesión no iniciada</h4>
            <p>Por favor, regresa a la página principal para iniciar una sesión antes de escanear un código QR.</p>
            <a href="visit.html" class="btn btn-primary">Iniciar Sesión</a>
        </div>

        <!-- Task Forms Container -->
        <div id="tasks-container">
            <!-- Forms are still here, just hidden -->
            <div id="superficie-sec-1-atras" class="task-form card"><div class="card-body"><h3 class="card-title">Superficie Sec 1 Atrás</h3><form data-task-id="superficie-sec-1-atras" data-task-title="Superficie Sec 1 Atrás"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="superficie-sec-2-atras" class="task-form card"><div class="card-body"><h3 class="card-title">Superficie Sec 2 Atrás</h3><form data-task-id="superficie-sec-2-atras" data-task-title="Superficie Sec 2 Atrás"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="superficie-sec-3-atras" class="task-form card"><div class="card-body"><h3 class="card-title">Superficie Sec 3 Atrás</h3><form data-task-id="superficie-sec-3-atras" data-task-title="Superficie Sec 3 Atrás"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="reinicio-lavadora-4" class="task-form card"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 4</h3><form data-task-id="reinicio-lavadora-4" data-task-title="Reinicio Lavadora 4"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="reinicio-lavadora-5" class="task-form card"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 5</h3><form data-task-id="reinicio-lavadora-5" data-task-title="Reinicio Lavadora 5"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="reinicio-lavadora-6" class="task-form card"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 6</h3><form data-task-id="reinicio-lavadora-6" data-task-title="Reinicio Lavadora 6"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="reinicio-lavadora-7" class="task-form card"><div class="card-body"><h3 class="card-title">Reinicio Lavadora 7</h3><form data-task-id="reinicio-lavadora-7" data-task-title="Reinicio Lavadora 7"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="superficies-lavadoras" class="task-form card"><div class="card-body"><h3 class="card-title">Superficies Lavadoras</h3><form data-task-id="superficies-lavadoras" data-task-title="Superficies Lavadoras"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="superficies-secadoras" class="task-form card"><div class="card-body"><h3 class="card-title">Superficies Secadoras</h3><form data-task-id="superficies-secadoras" data-task-title="Superficies Secadoras"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="revision-visual-inicio" class="task-form card"><div class="card-body"><h3 class="card-title">Revisión Visual Inicio</h3><form data-task-id="revision-visual-inicio" data-task-title="Revisión Visual Inicio"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="insumos-bodega" class="task-form card"><div class="card-body"><h3 class="card-title">Insumos Bodega</h3><form data-task-id="insumos-bodega" data-task-title="Insumos Bodega"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="insumos-maquinas-1" class="task-form card"><div class="card-body"><h3 class="card-title">Insumos Maquinas 1</h3><form data-task-id="insumos-maquinas-1" data-task-title="Insumos Maquinas 1"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="insumos-maquinas-2" class="task-form card"><div class="card-body"><h3 class="card-title">Insumos Maquinas 2</h3><form data-task-id="insumos-maquinas-2" data-task-title="Insumos Maquinas 2"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="tirar-botes-bodega" class="task-form card"><div class="card-body"><h3 class="card-title">Tirar Botes Bodega</h3><form data-task-id="tirar-botes-bodega" data-task-title="Tirar Botes Bodega"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="revision-bombas-1" class="task-form card"><div class="card-body"><h3 class="card-title">Revision Bombas 1</h3><form data-task-id="revision-bombas-1" data-task-title="Revision Bombas 1"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="revision-bombas-2" class="task-form card"><div class="card-body"><h3 class="card-title">Revision Bombas 2</h3><form data-task-id="revision-bombas-2" data-task-title="Revision Bombas 2"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="limpieza-entrada-billetes" class="task-form card"><div class="card-body"><h3 class="card-title">Limpieza Entrada Billetes</h3><form data-task-id="limpieza-entrada-billetes" data-task-title="Limpieza Entrada Billetes"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="limpieza-entrada-tarjetas" class="task-form card"><div class="card-body"><h3 class="card-title">Limpieza Entrada Tarjetas</h3><form data-task-id="limpieza-entrada-tarjetas" data-task-title="Limpieza Entrada Tarjetas"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="limpieza-filtro-secadora-1" class="task-form card"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 1</h3><form data-task-id="limpieza-filtro-secadora-1" data-task-title="Limpieza Filtro Secadora 1"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="limpieza-filtro-secadora-2" class="task-form card"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 2</h3><form data-task-id="limpieza-filtro-secadora-2" data-task-title="Limpieza Filtro Secadora 2"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="limpieza-filtro-secadora-3" class="task-form card"><div class="card-body"><h3 class="card-title">Limpieza Filtro Secadora 3</h3><form data-task-id="limpieza-filtro-secadora-3" data-task-title="Limpieza Filtro Secadora 3"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="barrer" class="task-form card" data-mandatory="true"><div class="card-body"><h3 class="card-title">Barrer</h3><form data-task-id="barrer" data-task-title="Barrer"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="trapear" class="task-form card" data-mandatory="true"><div class="card-body"><h3 class="card-title">Trapear</h3><form data-task-id="trapear" data-task-title="Trapear"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="descarga-de-billetes" class="task-form card"><div class="card-body"><h3 class="card-title">Descarga de Billetes</h3><form data-task-id="descarga-de-billetes" data-task-title="Descarga de Billetes"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="movimientos" class="task-form card"><div class="card-body"><h3 class="card-title">Movimientos</h3><form data-task-id="movimientos" data-task-title="Movimientos"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="descarga-de-monedas" class="task-form card"><div class="card-body"><h3 class="card-title">Descarga de Monedas</h3><form data-task-id="descarga-de-monedas" data-task-title="Descarga de Monedas"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="carga-en-fondo" class="task-form card"><div class="card-body"><h3 class="card-title">Carga en Fondo</h3><form data-task-id="carga-en-fondo" data-task-title="Carga en Fondo"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="carga-de-tarjetas-cliente" class="task-form card"><div class="card-body"><h3 class="card-title">Carga de Tarjetas Cliente</h3><form data-task-id="carga-de-tarjetas-cliente" data-task-title="Carga de Tarjetas Cliente"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
            <div id="carga-de-papel-impresion" class="task-form card"><div class="card-body"><h3 class="card-title">Carga de Papel Impresión</h3><form data-task-id="carga-de-papel-impresion" data-task-title="Carga de Papel Impresión"><p>¿Se completó la tarea correctamente?</p><div class="form-group"><div class="form-check"><input class="form-check-input" type="radio" name="status" value="Yes" required><label class="form-check-label">Sí</label></div><div class="form-check"><input class="form-check-input" type="radio" name="status" value="No"><label class="form-check-label">No</label></div></div><button type="submit" class="btn btn-info">Guardar Tarea</button></form></div></div>
        </div>

        <div id="submit-all-container" class="text-center">
            <h3>Finalizar Visita</h3>
            <p>Has completado <span id="completed-tasks-count-final">0</span> tarea(s). ¿Deseas enviar el registro de la visita ahora?</p>
            <div id="mandatory-tasks-tooltip" class="alert alert-warning" style="display: none;"></div>
            <button id="submit-all-btn" class="btn btn-primary btn-lg">Enviar Registro de Visita</button>
            <div class="mt-2" id="feedback-final" style="display:none;"></div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'YOUR_AWS_API_ENDPOINT_HERE';

        document.addEventListener('DOMContentLoaded', () => {
            const visitId = getOrSetVisitId();
            document.getElementById('visit-id-display').textContent = visitId;

            checkInitialSetup();
            handleRouteChange(); // Handle initial hash if present

            window.addEventListener('hashchange', handleRouteChange);
            document.getElementById('setup-form').addEventListener('submit', saveInitialSetup);
            document.getElementById('tasks-container').addEventListener('submit', saveTaskProgress);
            document.getElementById('submit-all-btn').addEventListener('click', submitAllTasks);
            checkMandatoryTasks(); // Initial check
        });

        function getVisitData() {
            const visitId = getOrSetVisitId();
            const data = localStorage.getItem(`visitData_${visitId}`);
            return data ? JSON.parse(data) : { tasks: {} };
        }

        function saveVisitData(data) {
            const visitId = getOrSetVisitId();
            localStorage.setItem(`visitData_${visitId}`, JSON.stringify(data));
        }

        function getOrSetVisitId() {
            let visitId = sessionStorage.getItem('visitId');
            if (!visitId) {
                visitId = `visit-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                sessionStorage.setItem('visitId', visitId);
            }
            return visitId;
        }

        function checkInitialSetup() {
            const visitData = getVisitData();
            if (visitData.location && visitData.user) {
                document.getElementById('initial-setup').style.display = 'none';
                handleRouteChange(); // Show welcome or task
            } else {
                document.getElementById('initial-setup').style.display = 'block';
                document.getElementById('welcome-message').style.display = 'none';
            }
        }

        function saveInitialSetup(event) {
            event.preventDefault();
            const location = document.getElementById('location-select').value;
            const user = document.getElementById('user-select').value;

            const visitData = getVisitData();
            visitData.location = location;
            visitData.user = user;
            saveVisitData(visitData);

            // --- THIS IS THE FIX ---
            document.getElementById('initial-setup').style.display = 'none';
            document.getElementById('welcome-message').style.display = 'block';
        }

        function handleRouteChange() {
            const visitData = getVisitData();
            const taskId = window.location.hash.substring(1);
            const noSessionError = document.getElementById('no-session-error');
            const initialSetup = document.getElementById('initial-setup');
            const welcomeMessage = document.getElementById('welcome-message');
            const tasksContainer = document.getElementById('tasks-container');
            const submitContainer = document.getElementById('submit-all-container');

            // Hide all dynamic content first
            initialSetup.style.display = 'none';
            welcomeMessage.style.display = 'none';
            tasksContainer.style.display = 'none';
            submitContainer.style.display = 'none';
            noSessionError.style.display = 'none';
            document.querySelectorAll('.task-form').forEach(form => form.style.display = 'none');

            if (!visitData.location || !visitData.user) {
                if (taskId) {
                    // Trying to access a task without a session
                    noSessionError.style.display = 'block';
                } else {
                    // No session and no task, show setup
                    initialSetup.style.display = 'block';
                }
                return;
            }

            // Session exists, proceed to show task or welcome message
            let taskFound = false;
            if (taskId) {
                const taskForm = document.getElementById(taskId);
                if (taskForm) {
                    tasksContainer.style.display = 'block';
                    taskForm.style.display = 'block';
                    taskFound = true;
                }
            }

            if (!taskFound) {
                welcomeMessage.style.display = 'block';
                updateCompletedCount();
            }
        }

        function saveTaskProgress(event) {
            event.preventDefault();
            const form = event.target;
            const taskId = form.dataset.taskId;
            const taskTitle = form.dataset.taskTitle;
            const answer = form.elements['status'].value;

            const visitData = getVisitData();
            visitData.tasks[taskId] = {
                taskTitle: taskTitle,
                answer: answer,
                timestamp: new Date().toISOString()
            };
            saveVisitData(visitData);

            window.location.hash = '';
            form.reset();
            checkMandatoryTasks(); // Check after saving a task
        }

        function updateCompletedCount() {
            const visitData = getVisitData();
            const count = Object.keys(visitData.tasks).length;
            
            document.getElementById('completed-tasks-count').textContent = count;
            document.getElementById('completed-tasks-count-final').textContent = count;

            const submitContainer = document.getElementById('submit-all-container');
            if (count > 0) {
                submitContainer.style.display = 'block';
            } else {
                submitContainer.style.display = 'none';
            }
            checkMandatoryTasks(); // Check when the count is updated
        }

        function checkMandatoryTasks() {
            const visitData = getVisitData();
            const mandatoryTasks = document.querySelectorAll('[data-mandatory="true"]');
            const submitBtn = document.getElementById('submit-all-btn');
            const tooltip = document.getElementById('mandatory-tasks-tooltip');
            
            let allMandatoryCompleted = true;
            let missingTasks = [];

            mandatoryTasks.forEach(task => {
                const taskId = task.id;
                if (!visitData.tasks[taskId]) {
                    allMandatoryCompleted = false;
                    missingTasks.push(task.querySelector('h3').textContent);
                }
            });

            if (allMandatoryCompleted) {
                submitBtn.disabled = false;
                tooltip.style.display = 'none';
            } else {
                submitBtn.disabled = true;
                tooltip.innerHTML = `Por favor, completa las siguientes tareas obligatorias para continuar: <strong>${missingTasks.join(', ')}</strong>`;
                tooltip.style.display = 'block';
            }
        }

        async function submitAllTasks() {
            const visitId = getOrSetVisitId();
            const visitData = getVisitData();
            const feedbackEl = document.getElementById('feedback-final');

            const payload = {
                visitId: visitId,
                location: visitData.location,
                user: visitData.user,
                tasks: visitData.tasks,
                submissionTimestamp: new Date().toISOString()
            };

            console.log('Submitting final data:', payload);
            feedbackEl.textContent = 'Enviando...';
            feedbackEl.className = 'alert alert-info';
            feedbackEl.style.display = 'block';
            document.getElementById('submit-all-btn').disabled = true;

            try {
                // const response = await fetch(API_ENDPOINT, {
                //     method: 'POST',
                //     body: JSON.stringify(payload),
                //     headers: { 'Content-Type': 'application/json' }
                // });
                // if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                await new Promise(resolve => setTimeout(resolve, 1500));

                feedbackEl.textContent = '¡Registro de visita enviado con éxito!';
                feedbackEl.className = 'alert alert-success';
                
                localStorage.removeItem(`visitData_${visitId}`);
                sessionStorage.removeItem('visitId');
                
                document.getElementById('welcome-message').style.display = 'none';
                document.getElementById('submit-all-container').style.display = 'none';
                document.getElementById('completion-message').style.display = 'block';

            } catch (error) {
                console.error('Error submitting form:', error);
                feedbackEl.textContent = 'Error al enviar el registro. Inténtalo de nuevo.';
                feedbackEl.className = 'alert alert-danger';
                document.getElementById('submit-all-btn').disabled = false;
            }
        }
    </script>
</body>
</html>